<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" th:href="@{/img/icon.png}" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/global.css}" />
    <link rel="stylesheet" th:href="@{/css/discuss-detail.css}" />
    <link rel="stylesheet" th:href="@{/css/wangEditor.css}" />
    <link rel="stylesheet" th:href="@{/css/write-post.css}" />


    <title>水木社区-帖子详情</title>
</head>

<body>
    <div class="nk-container">
        <!-- 头部 -->
        <header class="bg-dark sticky-top" th:replace="index::header">
            <div class="container">
                <!-- 导航 -->
                <nav class="navbar navbar-expand-lg navbar-dark">
                    <!-- logo -->
                    <a class="navbar-brand" href="#"></a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse"
                        data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <!-- 功能 -->
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav mr-auto">
                            <li class="nav-item ml-3 btn-group-vertical">
                                <a class="nav-link" href="../index.html">首页</a>
                            </li>
                            <li class="nav-item ml-3 btn-group-vertical">
                                <a class="nav-link position-relative" href="letter.html">消息<span
                                        class="badge badge-danger">12</span></a>
                            </li>
                            <li class="nav-item ml-3 btn-group-vertical">
                                <a class="nav-link" href="register.html">注册</a>
                            </li>
                            <li class="nav-item ml-3 btn-group-vertical">
                                <a class="nav-link" href="login.html">登录</a>
                            </li>
                            <li class="nav-item ml-3 btn-group-vertical dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <img src="http://images.nowcoder.com/head/1t.png" class="rounded-circle"
                                        style="width:30px;" />
                                </a>
                                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                    <a class="dropdown-item text-center" href="profile.html">个人主页</a>
                                    <a class="dropdown-item text-center" href="setting.html">账号设置</a>
                                    <a class="dropdown-item text-center" href="login.html">退出登录</a>
                                    <div class="dropdown-divider"></div>
                                    <span class="dropdown-item text-center text-secondary">nowcoder</span>
                                </div>
                            </li>
                        </ul>
                        <!-- 搜索 -->
                        <form class="form-inline my-2 my-lg-0" action="search.html">
                            <input class="form-control mr-sm-2" type="search" aria-label="Search" />
                            <button class="btn btn-outline-light my-2 my-sm-0" type="submit">搜索</button>
                        </form>
                    </div>
                </nav>
            </div>
        </header>

        <!-- 内容 -->
        <div class="main">
            <div class="container fx sb">
                <div class="post-container">
                  <div class="post-content">
                        <!-- 标题 -->
                    <h6 class="mb-4">
                        <img src="http://static.nowcoder.com/images/img/icons/ico-discuss.png" />
                        <span th:utext="${post.title}">备战春招，面试刷题跟他复习，一个月全搞定！</span>
                        <div class="float-right">
                            <input type="hidden" id="postId" th:value="${post.id}">
                            <button type="button" class="btn btn-danger btn-sm" id="topBtn"
                                th:disabled="${post.type==1}" sec:authorize="hasAnyAuthority('moderator')">置顶
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" id="wonderfulBtn"
                                th:disabled="${post.status==1}" sec:authorize="hasAnyAuthority('moderator')">加精
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" id="deleteBtn"
                                th:disabled="${post.status==2}" sec:authorize="hasAnyAuthority('admin')">删除
                            </button>
                        </div>
                    </h6>
                    <!-- 作者 -->
                    <div class="media pb-3 border-bottom">
                        <a th:href="@{|/user/profile/${user.id}|}">
                            <img th:src="${user.headerUrl}" class="align-self-start mr-4 rounded-circle user-header"
                                alt="用户头像">
                        </a>
                        <div class="media-body">
                            <a th:href="@{|/user/profile/${user.id}|}" class="mt-0 text-warning"
                                th:utext="${user.username}">寒江雪</a>
                            <div class="text-muted mt-3">
                                发布于 <b class="time" th:datetime="${#dates.format(post.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b>
                        <ul class="d-inline float-right">
                            <li class="d-inline ml-2">
                                <a href="javascript:;" th:onclick="|like(this,1,${post.id},${post.userId},${post.id});|"
                                   class="text-primary">
                                    <b th:text="${likeStatus==1?'已赞':'赞'}">赞</b> <i th:text="${likeCount}">11</i>
                                </a>
                            </li>
                            <li class="d-inline ml-2">|</li>
                            <li class="d-inline ml-2"><a href="javascript:;" th:onclick="|inputFocus(ENTITY_TYPE_POST,${post.id},0)|" class="text-primary">回帖</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- 正文 -->
            <div class="mt-4 mb-3 content" th:utext="${post.content}">
                正文
            </div>
                  </div>
                  <div class="comment-content mt-3">
                           <!-- 回帖数量 -->
                <div class="row">
                    <div class="col-8">
                        <h6><b class="square"></b> <i th:text="${post.commentCount}">30</i>条回帖</h6>
                    </div>
                    <!-- 排序按钮 -->
                    <div class="sort col-2">
                        <a href="javascript:;" class="shang-btn btn btn-sm text-left "><span class="sort-text">按点赞排序</span>&nbsp;&nbsp;
                            <span class="arrow iconfont">&#xe692;</span></a>
                        <div class="btn-list">
                            <a th:href="@{|/discuss/detail/${post.id}?orderMode=0|}" class="btn btn-sm text-left">按点赞排序</a>
                            <a th:href="@{|/discuss/detail/${post.id}?orderMode=1|}" class="btn btn-sm text-left">按最新排序</a>
                            <a th:href="@{|/discuss/detail/${post.id}?orderMode=2|}" class="btn btn-sm text-left">按最晚排序</a>
                        </div>
                    </div>
                    <div class="col-2 text-right">
                        <a href="javascript:;" class="btn btn-primary btn-sm"
                        th:onclick="|inputFocus(ENTITY_TYPE_POST,${post.id},0)|">&nbsp;&nbsp;回&nbsp;&nbsp;帖&nbsp;&nbsp;</a>
                    </div>
                </div>
                <!-- 回帖列表 -->
                <ul class="list-unstyled mt-4">
                    <!-- 一级评论 -->
                    <li class="media pb-3 pt-3 mb-3 border-bottom" th:each="cvo:${comments}">
                        <a th:href="@{|/user/profile/${cvo.user.id}|}">
                            <img th:src="${cvo.user.headerUrl}" class="align-self-start mr-4 rounded-circle user-header"
                                alt="用户头像">
                        </a>
                        <div class="media-body">
                            <div class="mt-0">
                                <a th:href="@{|/user/profile/${cvo.user.id}|}" class="font-size-12 text-success" th:utext="${cvo.user.username}">掉脑袋切切</a>
                                <span class="badge badge-secondary float-right floor">
                                        <i th:text="${page.offset + cvoStat.count}">1</i>#
                                    </span>
                            </div>
                            <div class="mt-2" th:if="${cvo.comment.status != 2}" th:utext="${cvo.comment.content}">
                                这开课时间是不是有点晚啊。。。
                            </div>
                            <div class="mt-2" th:unless="${cvo.comment.status != 2}">
                                该评论因违反社区规定，已被删除
                            </div>
                            <div class="mt-4 text-muted font-size-12">
                                <span>发布于 <b class="time" th:datetime="${#dates.format(cvo.comment.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b></span>
                                <ul class="d-inline float-right">
                                    <!-- 删除按钮 -->
                                    <input type="hidden"  th:value="${cvo.comment.id}">
                                    <li class="d-inline ml-2" th:if="${cvo.comment.status!=2}" sec:authorize="hasAnyAuthority('admin')">
                                        <a href="javascript:;" class="text-primary" onclick="deleteComment(this)">删除</a>
                                    </li>
                                    <li class="d-inline ml-2" th:if="${cvo.comment.status!=2}" sec:authorize="hasAnyAuthority('admin')">|</li>

                                    <!-- 折叠展开按钮 -->
                                    <li class="d-inline ml-2" th:if="${not#lists.isEmpty(cvo.replys)}">
                                        <a href="javascript:;" class="text-primary zhebtn">折叠以下回复</a>
                                    </li>
                                    <li class="d-inline ml-2" th:if="${not#lists.isEmpty(cvo.replys)}">|</li>
                                    <!-- 点赞 -->
                                    <li class="d-inline ml-2">
                                        <a href="javascript:;"
                                        th:onclick="|like(this,2,${cvo.comment.id},${cvo.comment.userId},${post.id});|"
                                        class="text-primary">
                                            <b th:text="${cvo.likeStatus==1?'已赞':'赞'}">赞</b>(<i
                                                th:text="${cvo.likeCount}">1</i>)
                                        </a>
                                    </li>
                                    <li class="d-inline ml-2">|</li>
                                    <!--(<i th:text="${cvo.replyCount}">2</i>)-->
                                    <li class="d-inline ml-2"><a href="javascript:;" class="text-primary"
                                                                th:onclick="|inputFocus(ENTITY_TYPE_COMMENT,${cvo.comment.id},0)|">回复</a>
                                    </li>
                                </ul>
                            </div>
                            <!-- 回复列表，包括二级评论和回复 -->
                            <ul class="list-unstyled mt-4 bg-gray p-3 font-size-12 text-muted reply-list"
                                th:if="${not#lists.isEmpty(cvo.replys)}">

                                <li class="pb-3 pt-3 mb-3 border-bottom" th:each="rvo:${cvo.replys}">
                                    <div>
                                        <!-- 二级评论 -->
                                        <span th:if="${rvo.target==null}">
                                            <a th:href="@{|/user/profile/${rvo.user.id}|}" class="text-info" th:text="${rvo.user.username}">寒江雪</a>:&nbsp;&nbsp;
                                        </span>
                                        <!-- 回复 -->
                                        <span th:if="${rvo.target!=null}">
                                            <a th:href="@{|/user/profile/${rvo.user.id}|}" class="text-info" th:text="${rvo.user.username}">Sissi</a> 回复
                                            <a th:href="@{|/user/profile/${rvo.target.id}|}" class="text-info" th:text="${rvo.target.username}">寒江雪</a>:&nbsp;&nbsp;
                                            </span>
                                        <span class="reply-content" th:if="${rvo.reply.status != 2}" th:utext="${rvo.reply.content}">这个是直播时间哈，觉得晚的话可以直接看之前的完整录播的~</span>
                                        <span class="reply-content" th:unless="${rvo.reply.status != 2}">该评论因违反社区规定，已被删除</span>
                                    </div>
                                    <div class="mt-3">
                                        发布于 <span class="time" th:datetime="${#dates.format(rvo.reply.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</span>
                                        <ul class="d-inline float-right">
                                            <!-- 删除按钮 -->
                                            <input type="hidden" th:value="${rvo.reply.id}">
                                            <li class="d-inline ml-2" th:if="${rvo.reply.status!=2}" sec:authorize="hasAnyAuthority('admin')">
                                                <a href="javascript:;" class="text-primary" onclick="deleteComment(this)">删除</a>
                                            </li>
                                            <li class="d-inline ml-2" th:if="${rvo.reply.status!=2}" sec:authorize="hasAnyAuthority('admin')">|</li>

                                            <!-- 点赞 -->
                                            <li class="d-inline ml-2">
                                                <a href="javascript:;"
                                                th:onclick="|like(this,2,${rvo.reply.id},${rvo.reply.userId},${post.id});|"
                                                class="text-primary">
                                                    <b th:text="${rvo.likeStatus==1?'已赞':'赞'}">赞</b>(<i
                                                        th:text="${rvo.likeCount}">1</i>)
                                                </a>
                                            </li>
                                            <li class="d-inline ml-2">|</li>
                                            <!-- 回复 -->
                                            <li class="d-inline ml-2"><a href="javascript:;"
                                                                        th:onclick="|inputFocus(ENTITY_TYPE_COMMENT,${cvo.comment.id},${rvo.reply.userId})|"
                                                                        data-toggle="collapse"
                                                                        class="text-primary">回复</a>
                                            </li>
                                        </ul>
                                    
                                    </div>
                                </li>

                            </ul>
                        </div>
                    </li>
                </ul>
                <!-- 分页 -->
                <nav class="mt-5" th:replace="index::pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item"><a class="page-link" href="#">首页</a></li>
                        <li class="page-item disabled"><a class="page-link" href="#">上一页</a></li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item"><a class="page-link" href="#">4</a></li>
                        <li class="page-item"><a class="page-link" href="#">5</a></li>
                        <li class="page-item"><a class="page-link" href="#">下一页</a></li>
                        <li class="page-item"><a class="page-link" href="#">末页</a></li>
                    </ul>
                </nav>
                <div class="edit">
                    <div id="editor">

                    </div>
                    <div class="fx je">
                    <div class="publish bg-blue" onclick="publish()">发布</div>
                    </div>
                    <!--提示框-->
                    <div class="modal fade" id="hintModal" tabindex="-1" role="dialog" aria-labelledby="hintModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="hintModalLabel">提示</h5>
                                </div>
                                <div class="modal-body" id="hintBody">
                                    发布完毕!
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                  </div>
                </div>
                <div class="aside-container">
                    <p class="text-center my-blue hot-bang">推荐帖子</p>
                   <ul class="list-unstyled">
                    <li class="media pb-2 pt-2 border-bottom " th:each="post:${commendPosts}">
                        <div class="media-body">
                            <div class="mb-3">
                                <a class="commend-title my-black" th:href="@{/discuss/detail/{id}(id=${post.id},orderMode=0)}" th:utext="${post.title}">标题</a>
                            </div>
                            <div class="text-muted font-size-12">
                                发布于 <b class="time" th:datetime="${#dates.format(post.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b>
                                <ul class="d-inline float-right">
                                    <li class="d-inline ml-2">赞 <span th:text="${post.likeCount}">11</span></li>
                                    <li class="d-inline ml-2">回帖 <span th:text="${post.commentCount}">7</span></li>
                                </ul>
                            </div>
                        </div>
                    </li>
                   </ul>
                </div>
            </div>

           


        </div>

    <!-- 尾部 -->
    <footer class="bg-white">
        <div class="container">
            <div class="row">
                
                <!-- 公司信息 -->
                <div class="col-8 detail-info m-auto">
                    <div class="row">
                        <div class="col">
                            <ul class="nav">
                                <li class="nav-item">
                                    <a class="nav-link " href="#">关于我们</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link " href="#">加入我们</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link " href="#">意见反馈</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link " href="#">企业服务</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link " href="#">联系我们</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link " href="#">免责声明</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link " href="#">友情链接</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <ul class="nav btn-group-vertical company-info">
                                <li class="nav-item ">
                                    水木社区©2020 All rights reserved
                                </li>
                                <li class="nav-item ">
                                    京ICP备14055008号-4 &nbsp;&nbsp;&nbsp;&nbsp;
                                    <img src="http://static.nowcoder.com/company/images/res/ghs.png" style="width:18px;" />
                                    京公网安备 11010502036488号
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.bootcss.com/timeago.js/3.0.2/timeago.js" crossorigin="anonymous"></script>

<script th:src="@{/js/global.js}"></script>
<script th:src="@{/js/discuss.js}"></script>
<script th:src="@{/js/wangEditor.js}"></script>
<script th:src="@{/js/discuss-detail.js}"></script>


<script th:inline="javascript">
    const ENTITY_TYPE_POST = 1
    const ENTITY_TYPE_COMMENT = 2

    var editor = null
    //设置富文本编辑器
    $(function () {

        var E = window.wangEditor;
        //这里的id为<div id="editor"中的id.
        editor = new E('#editor');
        // 配置服务器端地址,也就是controller的请求路径，不带项目路径，前面没有/
        // editor.customConfig.uploadImgServer = 'commodity/upload/editor/img';
        //配置属性名称，绑定请求的图片数据
        //controller会用到，可以随便设置，但是一定要与controller一致
        // editor.customConfig.uploadFileName = 'img';
        //创建编辑器
        editor.customConfig.uploadImgShowBase64 = true   // 使用 base64 保存图片
        editor.customConfig.showLinkImg = false

        editor.create();
    })

    var postId = 0
    var entityType = ENTITY_TYPE_POST
    var entityId = null
    var targetId = 0
    //设置postId和entityId
    $(function () {
        postId = /*[[${post.id}]]*/ "0"
        entityId = postId
    })
    //回复
    function publish() {
        // console.log(postId)
        // console.log(entityType)
        // console.log(entityId)
        // console.log(targetId)
        // 获取标题和内容
        var content = editor.txt.html();
        //内容为空
        if (!isValid(content)) {
            $("#hintBody").text("内容不能为空！");
            $("#hintModal").modal("show");
            setTimeout(function () {
                $("#hintModal").modal("hide");
                // 刷新页面
            }, 2000);
            return
        }
        // 发送异步请求(POST)
        $.post(
            CONTEXT_PATH + "/comment/add/" + postId,
            { "content": content, "entityType": entityType, "entityId": entityId, "targetId": targetId },
            function (data) {
                console.log(data)
                data = $.parseJSON(data);
                // 在提示框中显示返回消息
                $("#hintBody").text(data.msg);
                // 显示提示框
                $("#hintModal").modal("show");
                // 2秒后,自动隐藏提示框
                setTimeout(function () {
                    $("#hintModal").modal("hide");
                    // 刷新页面
                    if (data.code == 0) {
                        window.location.reload()
                        // return false
                    }
                }, 2000);
                var entityType = ENTITY_TYPE_POST
                var entityId = postId
                var targetId = 0
            }
        );
    }
    //富文本编辑器获取焦点
    function inputFocus(et, ei, ti = 0) {
        var position = $("#editor").offset();
        position.top = position.top - 215;
        $("html,body").animate({ scrollTop: position.top }, 100);
        //获取富文本编辑器的焦点
        editor.$textElem.focus()
        //赋值
        entityType = et
        entityId = ei
        targetId = ti
        // console.log(entityType)
        console.log(entityId)
        // console.log(targetId)
        // console.log(postId)
    }
    //设置排序按钮的文本
    var orderMode = 0
    $(function () {
        orderMode = /*[[${orderMode}]]*/ 0
        switch (orderMode) {
            case 0:
                $('.sort-text').text("按点赞排序");
                break;
            case 1:
                $('.sort-text').text("按最新排序");
                break;
            case 2:
                $('.sort-text').text("按最晚排序");
                break;

            default:
                $('.sort-text').text("按点赞排序");
                break;
        }
    })


</script>
</body>
</html>